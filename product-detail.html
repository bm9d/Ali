<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Nebulla Fragrance</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@400;500;600&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF9; color: #4B4B4B; }
        h1, h2, h3, h4, .font-display { font-family: 'Cormorant Garamond', serif; }
        html[dir="rtl"] body, html[dir="rtl"] h1, html[dir="rtl"] h2, html[dir="rtl"] h3, html[dir="rtl"] h4, html[dir="rtl"] .font-display, html[dir="rtl"] button, html[dir="rtl"] input, html[dir="rtl"] textarea, html[dir="rtl"] a { font-family: 'Cairo', sans-serif; }
        #mobileMenu { transition: transform 0.3s ease-in-out; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="antialiased">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[9999]">
        <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-t-rose-400 rounded-full animate-spin"></div>
    </div>
    <div id="notification-container" class="fixed top-5 right-5 z-[9998] space-y-3"></div>

    <header id="header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="text-3xl font-bold font-display text-rose-900">Nebulla Fragrance</a>
                <nav class="hidden lg:flex items-center space-x-8">
                    <a href="index.html" class="text-gray-700 hover:text-rose-500" data-lang-key="nav_home">Home</a>
                    <a href="products.html" class="text-gray-700 hover:text-rose-500" data-lang-key="nav_products">Products</a>
                    <a href="about.html" class="text-gray-700 hover:text-rose-500" data-lang-key="nav_about">About</a>
                    <a href="contact.html" class="text-gray-700 hover:text-rose-500" data-lang-key="nav_contact">Contact</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <button id="lang-switcher" class="text-gray-600 hover:text-rose-500 font-semibold text-sm px-3 py-1 border border-gray-300 rounded-full">EN</button>
                    <a href="cart.html" class="relative text-gray-600 hover:text-rose-500">
                        <i class="fas fa-shopping-bag fa-lg"></i>
                        <span id="cartCount" class="absolute -top-2 -right-2 bg-rose-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </a>
                    <button id="mobileMenuToggle" class="lg:hidden text-gray-600 hover:text-rose-500"><i class="fas fa-bars fa-lg"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div id="mobileMenu" class="fixed top-0 right-0 h-full w-72 bg-white shadow-2xl z-[60] transform translate-x-full lg:hidden">
        <div class="p-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="font-display text-2xl text-rose-900" data-lang-key="menu_title">Menu</h2>
                <button id="closeMobileMenu" class="text-gray-600 hover:text-rose-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav class="flex flex-col space-y-6">
                <a href="index.html" class="text-lg text-gray-700" data-lang-key="nav_home_mobile">Home</a>
                <a href="products.html" class="text-lg text-gray-700" data-lang-key="nav_products_mobile">Products</a>
                <a href="about.html" class="text-lg text-gray-700" data-lang-key="nav_about_mobile">About</a>
                <a href="contact.html" class="text-lg text-gray-700" data-lang-key="nav_contact_mobile">Contact</a>
            </nav>
        </div>
    </div>
    <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/40 z-55 hidden lg:hidden"></div>

    <main>
        <nav class="bg-rose-50 py-3">
            <div class="container mx-auto px-4">
                <ol id="breadcrumb" class="flex items-center gap-2 text-sm text-gray-500">
                    <li><a href="index.html" class="hover:text-rose-700" data-lang-key="breadcrumb_home">Home</a></li>
                    <li><span class="text-gray-300">/</span></li>
                    <li><a href="products.html" class="hover:text-rose-700" data-lang-key="breadcrumb_products">Products</a></li>
                    <li><span class="text-gray-300">/</span></li>
                    <li id="breadcrumbProduct" class="font-medium text-gray-700 truncate" data-lang-key="breadcrumb_loading">Loading...</li>
                </ol>
            </div>
        </nav>

        <section class="py-12 md:py-16">
            <div class="container mx-auto px-4">
                <div id="productDetailGrid" class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-16 items-start"></div>
            </div>
        </section>

        <section class="py-12 md:py-16 bg-rose-50">
            <div class="container mx-auto px-4">
                <h2 class="text-4xl md:text-5xl font-display text-center text-gray-800 mb-12" data-lang-key="related_title">You May Also Like</h2>
                <div id="relatedProductsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300">
        <div class="container mx-auto px-4 py-16">
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12">
                <div class="md:col-span-2 lg:col-span-1">
                    <h3 class="font-display text-2xl text-white mb-4">Nebulla Fragrance</h3>
                    <p class="text-gray-400 mb-4" data-lang-key="footer_desc">Crafting memories through the art of perfumery.</p>
                </div>
                <div><h4 class="font-semibold text-lg text-white mb-4" data-lang-key="footer_shop">Shop</h4><ul class="space-y-2"><li><a href="products.html" class="hover:text-white" data-lang-key="footer_all_products">All Products</a></li></ul></div>
                <div><h4 class="font-semibold text-lg text-white mb-4" data-lang-key="footer_support">Support</h4><ul class="space-y-2"><li><a href="contact.html" class="hover:text-white" data-lang-key="footer_contact_us">Contact Us</a></li></ul></div>
                <div><h4 class="font-semibold text-lg text-white mb-4" data-lang-key="footer_contact_info">Contact</h4><p>info@nebullafragrance.com</p><p>+1 (555) 123-4567</p></div>
            </div>
            <div class="mt-12 pt-8 border-t border-gray-700 text-center text-gray-500" data-lang-key="footer_copyright">&copy; 2025 Nebulla Fragrance. All Rights Reserved.</div>
        </div>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const translations = {
        en: {
            nav_home: "Home", nav_products: "Products", nav_about: "About", nav_contact: "Contact", menu_title: "Menu", nav_home_mobile: "Home", nav_products_mobile: "Products", nav_about_mobile: "About", nav_contact_mobile: "Contact",
            breadcrumb_home: "Home", breadcrumb_products: "Products", breadcrumb_loading: "Loading...",
            scent_family: "Scent Family", availability: "Availability", in_stock: "In Stock", out_of_stock: "Out of Stock", add_to_cart: "Add to Cart",
            feature_shipping: "Free shipping on orders over $50", feature_returns: "30-day easy return policy", feature_authentic: "100% authentic products guaranteed",
            related_title: "You May Also Like", related_none: "No related products found.",
            error_title: "An Error Occurred", error_no_product_spec: "No product specified in the URL.", error_not_found: "Sorry, we couldn't find that product.", error_failed_load: "There was a problem loading the page. Please try again later.", error_back_button: "Back to Products",
            footer_desc: "Crafting memories through the art of perfumery.", footer_shop: "Shop", footer_all_products: "All Products", footer_support: "Support", footer_contact_us: "Contact Us", footer_contact_info: "Contact", footer_copyright: "&copy; 2025 Nebulla Fragrance. All Rights Reserved."
        },
        ar: {
            nav_home: "الرئيسية", nav_products: "المنتجات", nav_about: "من نحن", nav_contact: "اتصل بنا", menu_title: "القائمة", nav_home_mobile: "الرئيسية", nav_products_mobile: "المنتجات", nav_about_mobile: "من نحن", nav_contact_mobile: "اتصل بنا",
            breadcrumb_home: "الرئيسية", breadcrumb_products: "المنتجات", breadcrumb_loading: "جار التحميل...",
            scent_family: "عائلة العطر", availability: "التوفر", in_stock: "متوفر", out_of_stock: "نفذت الكمية", add_to_cart: "أضف إلى السلة",
            feature_shipping: "شحن مجاني للطلبات التي تزيد عن 50 دولارًا", feature_returns: "سياسة إرجاع سهلة لمدة 30 يومًا", feature_authentic: "منتجات أصلية 100٪ مضمونة",
            related_title: "قد يعجبك ايضا", related_none: "لم يتم العثور على منتجات ذات صلة.",
            error_title: "حدث خطأ", error_no_product_spec: "لم يتم تحديد منتج في الرابط.", error_not_found: "عذراً، لم نتمكن من العثور على هذا المنتج.", error_failed_load: "حدثت مشكلة أثناء تحميل الصفحة. يرجى المحاولة مرة أخرى لاحقًا.", error_back_button: "العودة إلى المنتجات",
            footer_desc: "صياغة الذكريات من خلال فن العطور.", footer_shop: "تسوق", footer_all_products: "كل المنتجات", footer_support: "الدعم", footer_contact_us: "اتصل بنا", footer_contact_info: "معلومات الاتصال", footer_copyright: "&copy; 2025 نيبولا للعطور. جميع الحقوق محفوظة."
        }
    };
    const langSwitcher = document.getElementById('lang-switcher');
    let currentLang = localStorage.getItem('nebulla-lang') || 'ar';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('nebulla-lang', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        langSwitcher.textContent = lang === 'en' ? 'AR' : 'EN';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (translations[lang][key]) {
                el.innerHTML = translations[lang][key];
            }
        });
    }
    langSwitcher.addEventListener('click', () => {
        const newLang = currentLang === 'en' ? 'ar' : 'en';
        setLanguage(newLang);
        init(); // Re-initialize to re-render content in the new language
    });

    const mockAllProducts = [
        { id: 'p1', name: 'Ocean Breeze', brand: 'Aqua Di Mare', price: 85.00, scent_family: 'Fresh', description: 'A refreshing and invigorating scent of the sea, with notes of salt and citrus.', stock: 15, image_url: 'https://placehold.co/800x1000/a2d2ff/ffffff?text=Ocean\\nBreeze' },
        { id: 'p2', name: 'Midnight Jasmine', brand: 'Fleur Noir', price: 120.00, scent_family: 'Floral', description: 'An elegant and romantic floral fragrance, capturing the essence of jasmine in full bloom.', stock: 8, image_url: 'https://placehold.co/800x1000/3d405b/ffffff?text=Midnight\\nJasmine' },
        { id: 'p3', name: 'Sandalwood & Cedar', brand: 'The Woodsman', price: 95.00, scent_family: 'Woody', description: 'A warm, earthy, and comforting scent with deep notes of sandalwood and cedarwood.', stock: 20, image_url: 'https://placehold.co/800x1000/81b29a/ffffff?text=Sandalwood\\n%26+Cedar' },
        { id: 'p4', name: 'Spiced Amber', brand: 'Orientale', price: 110.00, scent_family: 'Spicy', description: 'An exotic and mysterious fragrance featuring warm amber and a blend of oriental spices.', stock: 0, image_url: 'https://placehold.co/800x1000/e07a5f/ffffff?text=Spiced\\nAmber' },
        { id: 'p5', name: 'Golden Dune', brand: 'Desert Gems', price: 155.00, scent_family: 'Spicy', description: 'A rich and warm scent inspired by desert sands.', stock: 10, image_url: 'https://placehold.co/800x1000/f2c94c/ffffff?text=Golden\\nDune' },
        { id: 'p6', name: 'Emerald Forest', brand: 'Verdant', price: 130.00, scent_family: 'Woody', description: 'A deep, green fragrance reminiscent of a lush forest.', stock: 12, image_url: 'https://placehold.co/800x1000/27ae60/ffffff?text=Emerald\\nForest' },
    ];

    const formatCurrency = (amount, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
    const setLocalStorage = (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error(e); } };
    const getLocalStorage = (key, defaultValue = null) => { try { const i = localStorage.getItem(key); return i ? JSON.parse(i) : defaultValue; } catch (e) { return defaultValue; } };
    function showNotification(message, type = 'info', duration = 4000) {
        const container = document.getElementById('notification-container');
        if (!container) return;
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
        const notification = document.createElement('div');
        notification.className = `transform transition-all duration-300 ease-in-out translate-x-full opacity-0 ${colors[type]} text-white font-semibold py-3 px-5 rounded-lg shadow-xl`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => { notification.classList.remove('translate-x-full', 'opacity-0'); notification.classList.add('translate-x-0', 'opacity-100'); }, 100);
        setTimeout(() => { notification.classList.add('opacity-0'); setTimeout(() => container.removeChild(notification), 300); }, duration);
    }

    class CartManager {
        constructor() { this.cartKey = 'nebulla_fragrance_cart_v2'; this.cart = getLocalStorage(this.cartKey, []); this.updateCartDisplay(); }
        saveCart() { setLocalStorage(this.cartKey, this.cart); this.updateCartDisplay(); }
        addToCart(product, quantity) {
            const existingItem = this.cart.find(item => item.id === product.id);
            if (existingItem) { existingItem.quantity += quantity; } else { this.cart.push({ ...product, quantity }); }
            this.saveCart();
            showNotification(`${product.name} added to cart!`, 'success');
        }
        getCartCount() { return this.cart.reduce((total, item) => total + item.quantity, 0); }
        updateCartDisplay() {
            const count = this.getCartCount();
            document.querySelectorAll('#cartCount').forEach(el => { el.textContent = count; el.style.display = count > 0 ? 'flex' : 'none'; });
        }
    }
    window.cartManager = new CartManager();

    async function fetchProductById(productId) {
        return new Promise(resolve => {
            const siteProducts = getLocalStorage('nebulla_site_products', mockAllProducts);
            const product = siteProducts.find(p => p.id === productId);
            // Add full details if missing from homepage data
            const fullProduct = mockAllProducts.find(p => p.id === productId);
            setTimeout(() => resolve({ ...product, ...fullProduct }), 300);
        });
    }
    async function fetchRelatedProducts(scentFamily, currentId) { 
        return new Promise(resolve => {
            const siteProducts = getLocalStorage('nebulla_site_products', mockAllProducts);
            const related = siteProducts.filter(p => p.scent_family === scentFamily && p.id !== currentId).slice(0, 4);
            setTimeout(() => resolve(related), 300);
        });
    }

    function renderProductDetail(product) {
        const grid = document.getElementById('productDetailGrid');
        const t = translations[currentLang];
        const stockStatus = product.stock > 0 ? `<span class="text-green-600">${t.in_stock}</span>` : `<span class="text-red-600">${t.out_of_stock}</span>`;
        
        grid.innerHTML = `
            <div class="product-images"><img src="${product.image_url}" alt="${product.name}" class="w-full h-auto object-cover rounded-lg shadow-lg"></div>
            <div class="product-info">
                <p class="text-gray-500 mb-2">${product.brand}</p>
                <h1 class="font-display text-4xl md:text-5xl font-bold text-gray-900 mb-4">${product.name}</h1>
                <p class="font-display text-4xl text-rose-800 mb-6">${formatCurrency(product.price)}</p>
                <p class="text-gray-600 leading-relaxed mb-6">${product.description}</p>
                <div class="space-y-2 mb-8">
                   <p><strong>${t.scent_family}:</strong> ${product.scent_family}</p>
                   <p><strong>${t.availability}:</strong> ${stockStatus}</p>
                </div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <div class="flex items-center border border-gray-300 rounded-full">
                        <button class="quantity-btn w-12 h-12 text-xl" data-change="-1">-</button>
                        <input type="number" id="quantity" value="1" min="1" max="${product.stock}" readonly class="w-16 h-12 text-center border-none bg-transparent focus:outline-none focus:ring-0 font-semibold">
                        <button class="quantity-btn w-12 h-12 text-xl" data-change="1">+</button>
                    </div>
                    <button id="addToCartBtn" class="w-full sm:w-auto bg-rose-800 text-white font-semibold px-10 py-4 rounded-full shadow-lg hover:bg-rose-900 disabled:bg-gray-400" ${product.stock === 0 ? 'disabled' : ''}>
                        ${product.stock === 0 ? t.out_of_stock : t.add_to_cart}
                    </button>
                </div>
                <div class="mt-10 pt-6 border-t border-gray-200 space-y-4 text-gray-600">
                    <div class="flex items-center gap-3"><i class="fas fa-truck fa-fw text-rose-500"></i><span data-lang-key="feature_shipping">${t.feature_shipping}</span></div>
                    <div class="flex items-center gap-3"><i class="fas fa-undo fa-fw text-rose-500"></i><span data-lang-key="feature_returns">${t.feature_returns}</span></div>
                    <div class="flex items-center gap-3"><i class="fas fa-shield-alt fa-fw text-rose-500"></i><span data-lang-key="feature_authentic">${t.feature_authentic}</span></div>
                </div>
            </div>`;

        document.getElementById('breadcrumbProduct').textContent = product.name;
        document.title = `${product.name} - Nebulla Fragrance`;
        attachActionListeners(product);
    }

    function renderRelatedProducts(products) {
        const container = document.getElementById('relatedProductsGrid');
        if (!products || products.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 col-span-full" data-lang-key="related_none">${translations[currentLang].related_none}</p>`;
            return;
        }
        container.innerHTML = products.map(p => `
            <div class="group bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col">
                <a href="product-detail.html?id=${p.id}" class="block overflow-hidden">
                    <img src="${p.image_url}" alt="${p.name}" class="w-full h-80 object-cover transform group-hover:scale-105 transition-transform duration-500">
                </a>
                <div class="p-5 flex flex-col flex-grow">
                    <p class="text-sm text-gray-500 mb-1">${p.brand}</p>
                    <h3 class="text-xl font-display font-semibold text-gray-800 mb-2 flex-grow">${p.name}</h3>
                    <p class="text-lg font-semibold text-rose-800 mt-4">${formatCurrency(p.price)}</p>
                </div>
            </div>`).join('');
    }

    function renderError(messageKey) {
        const grid = document.getElementById('productDetailGrid');
        const t = translations[currentLang];
        grid.innerHTML = `
            <div class="col-span-full text-center py-16">
                <i class="fas fa-exclamation-triangle fa-3x text-red-300 mb-4"></i>
                <h2 class="text-2xl font-display text-gray-700">${t.error_title}</h2>
                <p class="text-gray-500 mb-6">${t[messageKey]}</p>
                <a href="products.html" class="bg-rose-800 text-white font-semibold px-6 py-3 rounded-full shadow-lg hover:bg-rose-900">${t.error_back_button}</a>
            </div>`;
    }

    function attachActionListeners(product) {
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const change = parseInt(btn.dataset.change);
                const quantityInput = document.getElementById('quantity');
                let currentValue = parseInt(quantityInput.value);
                let newValue = currentValue + change;
                if (newValue < 1) newValue = 1;
                if (newValue > product.stock) newValue = product.stock;
                quantityInput.value = newValue;
            });
        });

        document.getElementById('addToCartBtn')?.addEventListener('click', () => {
            const quantity = parseInt(document.getElementById('quantity').value);
            window.cartManager.addToCart(product, quantity);
        });
    }

    async function init() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        setLanguage(currentLang);
        window.cartManager.updateCartDisplay();
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            renderError('error_no_product_spec');
            document.getElementById('loadingOverlay').classList.add('hidden');
            return;
        }

        try {
            const product = await fetchProductById(productId);
            if (!product) {
                renderError('error_not_found');
                return;
            }
            renderProductDetail(product);
            const relatedProducts = await fetchRelatedProducts(product.scent_family, product.id);
            renderRelatedProducts(relatedProducts);
        } catch (error) {
            console.error(error);
            renderError('error_failed_load');
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }

    init();
});
</script>

</body>
</html>
